---
title: "urbanKfsModel"
author: "Jinshi"
date: "April 5, 2019"
output:
  word_document: default
  html_document: default
---

```{r preliminaries, message=FALSE, include=FALSE, echo=FALSE}
# Set chunks defaults; these options will be applied to all subsequent chunks
knitr::opts_chunk$set(results = 'hide', message = TRUE, include = TRUE, echo = FALSE,
                      fig.height = 5, fig.width = 7)

# OUTPUT_DIR		<- "outputs/"
# LOG_DIR			<- "logs/"
# INFN 			<- "AllCities_Victoria_RDS.csv"
# OUTFN 			<- "MGRsD-data-final.csv"
# SEPARATOR		<- "-------------------------------------------"

# if(!file.exists(OUTPUT_DIR)) dir.create(OUTPUT_DIR)
# if(!file.exists(LOG_DIR)) dir.create( LOG_DIR )

library(cowplot)
library(grid)
library(gridExtra)
# install.packages("soiltexture")
# library( soiltexture )
library("ggpubr")
library(ggplot2)
# install.packages("randomForest")
library(randomForest)
# install.packages('neuralnet')
library(neuralnet)
library(reshape)
library(scales)
library(devtools)
library(dplyr)

source('functions.R')
theme_set(theme_bw())

# -------------------------------------------


# Read and clean data
histdata <- read.csv(here::here("extdata/UrbanSoilK_V3.csv"))
subhist <- histdata[, c(5,4,3,9)]
head(subhist)
colnames(subhist) <- c("CLAY", "SILT", "SAND", "Unsaturated_K2cm_cmhr")
subhist$col <- "red"

data_orig <- read.csv(here::here("extdata/AllCities_Victoria_RDS.csv"))
# resetta test data
test_rosetta <- read.csv(here::here("extdata/test_with_rosetta_V3.csv"))
test_rosetta$Model <- 'ROSETTA'

# filt and clean data for soil triangle plot (Figure 1)
combdata <- clean_data(data_orig)
combdata$Unsaturated_K2cm_cmhr %>% min()
combdata$Unsaturated_K2cm_cmhr %>% max()
combdata$Unsaturated_K2cm_cmhr %>% mean()
combdata <- combdata[,c(1,2,3,6)]
combdata$col <- "blue"
colnames(combdata) <- colnames (subhist)
combdata <- rbind(combdata, subhist)
```


```{r Figure 1.1, fig.height=8, fig.width=8}
tiff(paste("outputs/Figure1-1.tiff"), width = 10, height = 10, pointsize = 1/300, units = 'in', res = 300)
# plot soil texture figure
TT.plot(
  class.sys = "USDA.TT",
  tri.data = combdata,
  # z.name = "OC",
  grid.col = "white",
  grid.lty = 1,
  arrows.show = TRUE,
  pch = 1,
  col = combdata$col,
  bg = "white",
  fg = "blue",
  main = "Soil texture triangle plot"
)
dev.off()

```


```{r Figure 1.2, fig.height=6, fig.width=6}
print(
  ggplot(combdata, aes(Unsaturated_K2cm_cmhr, stat(density), fill = col)) + 
  # geom_freqpoly()
  geom_histogram(binwidth = 2, col = 'gray') +
  # geom_density()+
  theme(legend.position = "none", legend.background = element_rect(fill = alpha('white',0.0))
        , axis.title = element_text(size = 20)
        , axis.text = element_text(size = 20)) +
  scale_fill_discrete(name = "Data", labels=c('Training', 'Verification')) +
  xlab(expression( K[fs]~(cm~h^{-1}) )) +
  ylab('Density')
)
# plot_grid(p1, p2, labels = c('( a ), ( b )'), vjust = 4, hjust = c(-2,-2))
ggsave("Figure1-2.jpg", width = 7.5, height = 7.5, dpi = 300, units = "in")

```

* Show Figure 2 (why not showing)
![Schematic diagram of ANN](manuscript/Figures/Figure 2.jpg)


```{r ANN model, message=FALSE, include = FALSE}
data_structure <- update_structure(data_orig)
data <- data_ann (data_structure)

maxs <- apply(data, 2, max) 
mins <- apply(data, 2, min)

scaled <- as.data.frame(scale(data, center = mins, scale = maxs - mins))
index <- sample(1:nrow(data),round(0.85*nrow(data)))

train <- scaled[index,]
test <- scaled[-index,]

ann_Ksat <- ann_ssc(train)

train$p.ann_Ksat <- neuralnet::compute(ann_Ksat, train[,c('Percent_Sand' , 'Percent_Silt' , 'Percent_Clay')])$net.result
test$p.ann_Ksat <- neuralnet::compute(ann_Ksat, test[,c('Percent_Sand' , 'Percent_Silt' , 'Percent_Clay')])$net.result
  
# scale back the value
train$kfs <- train$Unsaturated_K2cm_cmhr * (max(data$Unsaturated_K2cm_cmhr)-min(data$Unsaturated_K2cm_cmhr)) + min(data$Unsaturated_K2cm_cmhr)
train$kfs_m <- train$p.ann_Ksat * (max(data$Unsaturated_K2cm_cmhr)-min(data$Unsaturated_K2cm_cmhr)) + min(data$Unsaturated_K2cm_cmhr)
train$Model <- 'ANN'

# test data 
test$kfs <- test$Unsaturated_K2cm_cmhr * (max(data$Unsaturated_K2cm_cmhr)-min(data$Unsaturated_K2cm_cmhr)) + min(data$Unsaturated_K2cm_cmhr)
test$kfs_m <- test$p.ann_Ksat * (max(data$Unsaturated_K2cm_cmhr)-min(data$Unsaturated_K2cm_cmhr)) + min(data$Unsaturated_K2cm_cmhr)
test$Model <- 'ANN'
  
# correlation
cor(train$kfs_m, train$kfs, method = c("spearman"))
cor(test$kfs_m, test$kfs, method = c("spearman"))

```

```{r}
unique(data_structure$Top_Type)
```


```{r RF1 model without soil structure}
dataRF <- data_rf (data_structure)
train_RF <- dataRF[index,]
test_RF <- dataRF[-index,]

rf1 <- rf_ssc(train_RF)
# train dataset
train_RF$kfs_m <- predict(rf1, train_RF)
train_RF$Model <- 'rf1'
  
# test dataset
test_RF$kfs_m <- predict(rf1, test_RF)
test_RF$Model <- 'rf1'

cor(train_RF$kfs_m, train_RF$Unsaturated_K2cm_cmhr, method = c("spearman"))
cor(test_RF$kfs_m, test_RF$Unsaturated_K2cm_cmhr, method = c("spearman"))
```


```{r RF2 model with soil structure}
set.seed(20191120)
rf2 <- rf_sscs(data_structure)
# train dataset
train_RF2 <- train_RF
train_RF2$kfs_m <- predict(rf2, train_RF2)
train_RF2$Model <- 'rf2'
  
# test dataset
test_RF2 <- test_RF
test_RF2$kfs_m <- predict(rf2, test_RF2)
test_RF2$Model <- 'rf2'
  
cor(train_RF2$kfs_m, train_RF2$Unsaturated_K2cm_cmhr, method = c("spearman"))
cor(test_RF2$kfs_m, test_RF2$Unsaturated_K2cm_cmhr, method = c("spearman"))
```



```{r Figure 3}
importance(rf2, type = 1)
getwd()

pdf("Figure A2.pdf", height = 6, width = 8)
rf2_visual(model = rf2)
dev.off()

tiff(paste("Figure A2.tiff"), width = 8, height = 6, pointsize = 1/300, units = 'in', res = 300)
rf2_visual(model = rf2)
dev.off()
```



```{r Figure 4, fig.height=8, fig.width=7}
# plot measured kfs and predicted kfs by ANN
# colnames(train_RF)[7] <- 'kfs'
# colnames(train_RF2)[7] <- 'kfs'
# colnames(test_RF)[7] <- 'kfs'
# colnames(test_RF2)[7] <- 'kfs'
# colnames(test_rosetta)[c(8,11)] <- c('kfs', 'kfs_m')
# model_evaluation2()
```


```{r Figure 5}
# model_evaluation3 ()

```



```{r}
# test borehole data

```

