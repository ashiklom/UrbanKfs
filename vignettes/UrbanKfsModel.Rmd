---
title: "urbanKfsModel"
author: "Jinshi"
date: "April 5, 2019"
output:
  word_document: default
  html_document: default
---

```{r preliminaries, message=FALSE, include=FALSE, echo=FALSE}
# Set chunks defaults; these options will be applied to all subsequent chunks
knitr::opts_chunk$set(results = 'hide', message = TRUE, include = TRUE, echo = FALSE,
                      fig.height = 5, fig.width = 7)

# OUTPUT_DIR		<- "outputs/"
# LOG_DIR			<- "logs/"
# INFN 			<- "AllCities_Victoria_RDS.csv"
# OUTFN 			<- "MGRsD-data-final.csv"
# SEPARATOR		<- "-------------------------------------------"

# if(!file.exists(OUTPUT_DIR)) dir.create(OUTPUT_DIR)
# if(!file.exists(LOG_DIR)) dir.create( LOG_DIR )

library(cowplot)
library(grid)
library(gridExtra)
# install.packages("soiltexture")
# library( soiltexture )
library("ggpubr")
library(ggplot2)
# install.packages("randomForest")
library(randomForest)
# install.packages('neuralnet')
library(neuralnet)
library(reshape)
library(scales)
library(devtools)
library(dplyr)
library(readxl)

source('functions.R')
theme_set(theme_bw())
```

# Prepare data
```{r}
MFT3 <- read_excel("../extdata/MasterFlatTable_3July19_preColorRemov.xlsx", sheet = 4)
Surface_HC <- read_excel("../extdata/MasterFlatTable_3July19_preColorRemov.xlsx", sheet = 5)
Borehole_ksat <- read_excel("../extdata/MasterFlatTable_3July19_preColorRemov.xlsx", sheet = 6)
data_orig <- read.csv(here::here("extdata/old/AllCities_Victoria_RDS.csv"))

Borehole_ksat %>% select(SampleLayer_ID, Borehole_Ksat_cmhr, BulkDensity_gcm3) %>% 
  filter(!is.na(Borehole_Ksat_cmhr) & Borehole_Ksat_cmhr!=99999) %>% 
  group_by(SampleLayer_ID) %>% 
  summarise(Borehole_Ksat_cmhr = mean(Borehole_Ksat_cmhr),
            BulkDensity_gcm3 = mean(BulkDensity_gcm3)) ->
  Borehole_ksat_agg

left_join(
  MFT3, 
  Surface_HC %>% select(SampleLayer_ID, Unsaturated_K2cm_cmhr) %>% filter(!is.na(Unsaturated_K2cm_cmhr)),
  by = c("SampleLayer_ID")
) -> All_cite_new

left_join(
  All_cite_new,
  Borehole_ksat_agg,
  by = c("SampleLayer_ID")) ->
  All_cite_new

left_join(
  All_cite_new,
  data_orig %>% select(SampleLayer_ID, Latitude, Longitude, Type, hwsd_bd,
                       Texture_mod, Top_Type, Soil_Series_Type), 
  by = c("SampleLayer_ID")
) -> All_cite_new

All_cite_new$Ksat_cmhr <- ifelse(!is.na(All_cite_new$Unsaturated_K2cm_cmhr),
                                 All_cite_new$Unsaturated_K2cm_cmhr, All_cite_new$Borehole_Ksat_cmhr)

All_cite_new$Ksat_cmhr <- ifelse(All_cite_new$Ksat_cmhr == 0, 
                                 All_cite_new$Borehole_Ksat_cmhr,
                                 All_cite_new$Ksat_cmhr)

All_cite_new$BD <- ifelse(!is.na(All_cite_new$BulkDensity_gcm3),
                          All_cite_new$BulkDensity_gcm3,
                          All_cite_new$hwsd_bd)

All_cite_new %>% 
  select(BulkDensity_gcm3) %>% 
  na.omit()

All_cite_new %>% 
  select(Unsaturated_K2cm_cmhr) %>% 
  na.omit() %>% 
  arrange(Unsaturated_K2cm_cmhr)

All_cite_new %>% 
  select(Borehole_Ksat_cmhr) %>% 
  na.omit() %>% 
  arrange(Borehole_Ksat_cmhr)

All_cite_new %>% 
  select(Unsaturated_K2cm_cmhr, Borehole_Ksat_cmhr) %>% 
  na.omit() 

All_cite_new %>% 
  select(Percent_Sand, Percent_Silt, Percent_Clay, Ksat_cmhr, Type, BD) %>% 
  na.omit()

All_cite_new %>% 
  select(BD) %>% 
  unique()

# write.csv(All_cite_new, "../extdata/AllCities_Victoria_RDS.csv", row.names = F)
```







# Plot Figure 1
```{r}
# -------------------------------------------
# Read and clean data
histdata <- read.csv(here::here("extdata/UrbanSoilK_V3.csv"))
subhist <- histdata[, c(5,4,3,9)]
head(subhist)
colnames(subhist) <- c("CLAY", "SILT", "SAND", "Unsaturated_K2cm_cmhr")
subhist$col <- "red"

# resetta test data
test_rosetta <- read.csv(here::here("extdata/test_with_rosetta_V3.csv"))
test_rosetta$Model <- 'ROSETTA'

# filt and clean data for soil triangle plot (Figure 1)
data_orig <- read.csv(here::here("extdata/AllCities_Victoria_RDS.csv"))
combdata <- clean_data(data_orig)
combdata$Unsaturated_K2cm_cmhr %>% min()
combdata$Unsaturated_K2cm_cmhr %>% max()
combdata$Unsaturated_K2cm_cmhr %>% mean()
combdata <- combdata[,c(1,2,3,5)]
combdata$col <- "blue"
colnames(combdata) <- colnames (subhist)
combdata <- rbind(combdata, subhist)
```

### load HWSD BD data
```{r}
# HWSD_bd <- nc_open("../extdata/HWSD_BULK_DEN.nc4")
```



```{r Figure 1.1, fig.height=8, fig.width=8}
# tiff(paste("outputs/Figure1-1.tiff"), width = 10, height = 10, pointsize = 1/300, units = 'in', res = 300)
# plot soil texture figure
# TT.plot(
#   class.sys = "USDA.TT",
#   tri.data = combdata,
#   # z.name = "OC",
#   grid.col = "white",
#   grid.lty = 1,
#   arrows.show = TRUE,
#   pch = 1,
#   col = combdata$col,
#   bg = "white",
#   fg = "blue",
#   main = "Soil texture triangle plot"
# )
# dev.off()

```


```{r Figure 1.2, fig.height=6, fig.width=6}
print(
  ggplot(combdata, aes(Unsaturated_K2cm_cmhr, stat(density), fill = col)) + 
  # geom_freqpoly()
  geom_histogram(binwidth = 2, col = 'gray') +
  # geom_density()+
  theme(legend.position = "none", legend.background = element_rect(fill = alpha('white',0.0))
        , axis.title = element_text(size = 20)
        , axis.text = element_text(size = 20)) +
  scale_fill_discrete(name = "Data", labels=c('Training', 'Verification')) +
  xlab(expression( K[fs]~(cm~h^{-1}) )) +
  ylab('Density')
)
# plot_grid(p1, p2, labels = c('( a ), ( b )'), vjust = 4, hjust = c(-2,-2))
ggsave("Figure1-2.jpg", width = 7.5, height = 7.5, dpi = 300, units = "in")
```

* Show Figure 2 (why not showing)
![Schematic diagram of ANN](manuscript/Figures/Figure 2.jpg)


```{r ANN model, message=FALSE, include = FALSE}
data_structure <- update_structure(data_orig)
data <- data_ann (data_structure)

maxs <- apply(data, 2, max) 
mins <- apply(data, 2, min)

scaled <- as.data.frame(scale(data, center = mins, scale = maxs - mins))
index <- sample(1:nrow(data),round(0.85*nrow(data)))

train <- scaled[index,]
test <- scaled[-index,]

ann_Ksat <- ann_ssc(train)

train$p.ann_Ksat <- neuralnet::compute(ann_Ksat, train[,c('Percent_Sand' , 'Percent_Silt' , 'Percent_Clay')])$net.result
test$p.ann_Ksat <- neuralnet::compute(ann_Ksat, test[,c('Percent_Sand' , 'Percent_Silt' , 'Percent_Clay')])$net.result
  
# scale back the value
train$kfs <- train$Unsaturated_K2cm_cmhr * (max(data$Unsaturated_K2cm_cmhr)-min(data$Unsaturated_K2cm_cmhr)) + min(data$Unsaturated_K2cm_cmhr)
train$kfs_m <- train$p.ann_Ksat * (max(data$Unsaturated_K2cm_cmhr)-min(data$Unsaturated_K2cm_cmhr)) + min(data$Unsaturated_K2cm_cmhr)
train$Model <- 'ANN'

# test data 
test$kfs <- test$Unsaturated_K2cm_cmhr * (max(data$Unsaturated_K2cm_cmhr)-min(data$Unsaturated_K2cm_cmhr)) + min(data$Unsaturated_K2cm_cmhr)
test$kfs_m <- test$p.ann_Ksat * (max(data$Unsaturated_K2cm_cmhr)-min(data$Unsaturated_K2cm_cmhr)) + min(data$Unsaturated_K2cm_cmhr)
test$Model <- 'ANN'
  
# correlation
cor(train$kfs_m, train$kfs, method = c("spearman"))
cor(test$kfs_m, test$kfs, method = c("spearman"))
```

```{r}
data_structure %>% select(Top_Type, Type) %>% 
  filter(is.na(Top_Type))
```


```{r}
unique(data_structure$Top_Type)
```


```{r RF1 model without soil structure}
dataRF <- data_rf (data_structure)
train_RF <- dataRF[index,]
test_RF <- dataRF[-index,]

rf1 <- rf_ssc(train_RF)
# train dataset
train_RF$kfs_m <- predict(rf1, train_RF)
train_RF$Model <- 'rf1'
  
# test dataset
test_RF$kfs_m <- predict(rf1, test_RF)
test_RF$Model <- 'rf1'

cor(train_RF$kfs_m, train_RF$Unsaturated_K2cm_cmhr, method = c("spearman"))
cor(test_RF$kfs_m, test_RF$Unsaturated_K2cm_cmhr, method = c("spearman"))
```


```{r RF2 model with soil structure}
set.seed(20191120)
rf2 <- rf_sscs(data_structure)
# train dataset
train_RF2 <- train_RF
train_RF2$kfs_m <- predict(rf2, train_RF2)
train_RF2$Model <- 'rf2'
  
# test dataset
test_RF2 <- test_RF
test_RF2$kfs_m <- predict(rf2, test_RF2)
test_RF2$Model <- 'rf2'
  
cor(train_RF2$kfs_m, train_RF2$Unsaturated_K2cm_cmhr, method = c("spearman"))
cor(test_RF2$kfs_m, test_RF2$Unsaturated_K2cm_cmhr, method = c("spearman"))
```


```{r Figure 3}
importance(rf2, type = 1)
# getwd()

# pdf("Figure A2.pdf", height = 6, width = 8)
rf2_visual(model = rf2)
# dev.off()

# tiff(paste("Figure A2.tiff"), width = 8, height = 6, pointsize = 1/300, units = 'in', res = 300)
rf2_visual(model = rf2)
# dev.off()
```


## Test rock fragment
```{r scenario 1}
rock_test_data <- clean_data(data_orig)
rock_test_data %>% 
  filter(!is.na(ROCK)) %>% 
  filter(Unsaturated_K2cm_cmhr>0) %>% 
  mutate(Unsaturated_K2cm_cmhr = log(Unsaturated_K2cm_cmhr)) -> 
  rock_test_data
# no rock inputs
rf_no_rock <- randomForest(Unsaturated_K2cm_cmhr ~ SAND + SILT + CLAY, data=rock_test_data,
                           ntree = 100,
                           mtry = 2,
                           importance = TRUE,
                           proximity = TRUE)

rock_test_data$no_rock <- predict(rf_no_rock, rock_test_data)
cor(rock_test_data$no_rock, rock_test_data$Unsaturated_K2cm_cmhr, method = c("spearman"))

```


```{r scenario 2}
# SSC scale: sand + silt + clay = 100%
rock_test1 <- randomForest(Unsaturated_K2cm_cmhr ~ SAND + SILT + CLAY + ROCK, data=rock_test_data,
                           ntree = 100,
                           mtry = 2,
                           importance = TRUE,
                           proximity = TRUE)

# train dataset
rock_test_data$rock_m1 <- predict(rock_test1, rock_test_data)
cor(rock_test_data$rock_m1, rock_test_data$Unsaturated_K2cm_cmhr, method = c("spearman"))
```


```{r scenario 3}
# SSC scale scenario 2: sand + silt + clay + rock = 100%
# SSC scale scenario 1: sand + silt + clay = 100%
rock_test_data2 <- clean_data_rock(data_orig)
rock_test_data2 %>%
  filter(Unsaturated_K2cm_cmhr>0) %>% 
  mutate(Unsaturated_K2cm_cmhr = log(Unsaturated_K2cm_cmhr)) -> 
  rock_test_data2
  
rock_test_data2 %>% select(CLAY, SILT, SAND, ROCK) %>% 
  mutate(check = 100-CLAY-SILT-SAND-ROCK) %>% 
  arrange(check)

rock_test2 <- randomForest(Unsaturated_K2cm_cmhr ~ SAND + SILT + CLAY + ROCK, data=rock_test_data2,
                           ntree = 100,
                           mtry = 2,
                           importance = TRUE,
                           proximity = TRUE)

# train dataset
rock_test_data2$rock_m2 <- predict(rock_test2, rock_test_data2)
cor(rock_test_data2$rock_m2, rock_test_data2$Unsaturated_K2cm_cmhr, method = c("spearman"))
```


```{r scenario 4}
# don't scale sscr
data_orig %>% 
  select(Unsaturated_K2cm_cmhr, Percent_Sand, Percent_Clay, Percent_Silt, Percent_Rock_Fragment) %>% 
  na.omit() %>% 
  filter(Unsaturated_K2cm_cmhr > 0) %>% 
  mutate(Unsaturated_K2cm_cmhr = log(Unsaturated_K2cm_cmhr)) ->
  rock_test_data3

rock_test3 <- randomForest(Unsaturated_K2cm_cmhr ~ Percent_Sand + Percent_Clay + Percent_Silt + Percent_Rock_Fragment, data=rock_test_data3,
                           ntree = 100,
                           mtry = 2,
                           importance = TRUE,
                           proximity = TRUE)

# train dataset
rock_test_data3$rock_m3 <- predict(rock_test3, rock_test_data3)
cor(rock_test_data3$rock_m3, rock_test_data3$Unsaturated_K2cm_cmhr, method = c("spearman"))
```


```{r}
bind_rows(rock_test_data %>% 
            mutate(Model = "No rock (R^2=0.92)",
                   Predict = no_rock) %>% 
            select(Unsaturated_K2cm_cmhr, Predict, Model),
          rock_test_data %>% 
            mutate(Model = "ssc=100 (R^2=0.93)",
                   Predict = rock_m1) %>% 
            select(Unsaturated_K2cm_cmhr, Predict, Model), 
          rock_test_data2 %>% 
            mutate(Model = "sscr=100 (R^2=0.93)",
                   Predict = rock_m2) %>% 
            select(Unsaturated_K2cm_cmhr, Predict, Model),
          rock_test_data3 %>% 
            mutate(Model = "No scale (R^2=0.93)",
                   Predict = rock_m3) %>% 
            select(Unsaturated_K2cm_cmhr, Predict, Model)
          ) %>% 
  ggplot(aes(Predict, Unsaturated_K2cm_cmhr)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(. ~ Model, nrow = 2) +
  labs(x = expression(Predicted~K[fs]~(log~transfered)),
       y = expression(Measured~K[fs]~(log~transfered)))
  
```

```{r}
# normalize_soil_pct(30,30,50)
data_orig2 %>% 
  select(Unsaturated_K2cm_cmhr, Percent_Sand, Type
         , BulkDensity_gcm3
         ) %>% 
  na.omit()
```


## get latitude and longitude
```{r}
# SSURG_all <- read_excel("../extdata/All_SSURGO_and_Observed_All.xlsx", sheet = 3)
# SSURG_all <- SSURG_all
# left_join(
#   data_orig, 
#   SSURG_all %>% select(SampleLayer_ID, SampleSite_ID, SamplePoint_ID), by = c("SampleLayer_ID")
# ) -> data_orig2
# 
# left_join(
#   data_orig2,
#   site %>% select(SampleSite_ID, SamplePoint_ID, Latitude, Longitude),
#   by = c("SampleSite_ID", "SamplePoint_ID")
# ) -> data_orig2
# 
# data_orig2 %>% 
#   select(Unsaturated_K2cm_cmhr, Percent_Sand, Type
#          # , BulkDensity_gcm3
#          , Latitude, Longitude
#          ) %>% 
#   na.omit()
# 
# data_orig2 %>% 
#   select(Latitude, Longitude) %>% 
#   na.omit()
```


## get BD from HWSD if BD is null
### create function
```{r}
# get soil BD from HWSD
# data_orig3 <- get_bd(HWSD_bd, data_orig2)
# data_orig3$BulkDensity_gcm3 <- ifelse(is.na(data_orig3$BulkDensity_gcm3), data_orig3$hwsd_bd, data_orig3$BulkDensity_gcm3)
# # write.csv(data_orig3, "../extdata/AllCities_Victoria_RDS.csv", row.names = FALSE)
# data_orig3 %>% 
#   select(Unsaturated_K2cm_cmhr, Percent_Sand, Type
#          # , BulkDensity_gcm3
#          , Latitude, Longitude
#          ) %>% 
#   na.omit()
# 
# data_orig3 %>% 
#   select(Sort, Unsaturated_K2cm_cmhr, Percent_Sand, Type
#          , BulkDensity_gcm3, hwsd_bd
#          , Latitude, Longitude
#          ) %>% 
#   filter(!is.na(Unsaturated_K2cm_cmhr) & !is.na(Percent_Sand) & !is.na(Type)) %>% 
#   filter(is.na(BulkDensity_gcm3))

```

```{r}
# data_orig3 %>% select(BulkDensity_gcm3, hwsd_bd) %>% 
#   na.omit() %>% 
#   ggplot(aes(hwsd_bd, BulkDensity_gcm3)) +
#   geom_point() +
#   geom_smooth(method = "lm")
```
